<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>awsrun.plugins.accts.azure API documentation</title>
<meta name="description" content="Account loader plugins specific to Azure â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<link href="/awsrun/webfonts.css" rel="stylesheet">
<style>
body {
font-size: 17px;
font-family: Charter-Racket, serif;
}
code {
font-family: Fira-Mono, monospace;
}
/* `Text` size and code blocks in main body */
section code {
font-size: 15px;
}
/* "expand source code" text */
details {
font-size: 14px;
}
ul li code a {
font-size: .9em;
}
dt {
font-weight: bold;
}
h4 {
font-weight: bold;
}
</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>awsrun.plugins.accts.azure</code></h1>
</header>
<section id="section-intro">
<p>Account loader plugins specific to Azure.</p>
<p>The plug-in in this module allows a user to select subscriptions using the
metadata filters on the <code><a title="awsrun.cli" href="../../cli.html">awsrun.cli</a></code> instead of explicitly listing accounts to
process.
For accounts that are explicitly specified, the plug-ins are used to
validate those accounts exist. Most plugins in this module attach metadata
attributes to the account objects, which are made available to command authors.</p>
<p>Refer to the plug-in's documentation for a list of valid options that can be
provided via the configuration file or via azurerun CLI flags. CLI flags
override the values defined in the configuration file. The <code>plugin</code> key may be
one of the following values:</p>
<dl>
<dt>awsrun.plugins.accts.azure.AzureCLI</dt>
<dd><code><a title="awsrun.plugins.accts.azure.AzureCLI" href="#awsrun.plugins.accts.azure.AzureCLI">AzureCLI</a></code> loads subscriptions and metadata for those subscriptions via the
Azure CLI <code>az account list --all</code>
command.</dd>
</dl>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#
# Copyright 2019 FMR LLC &lt;opensource@fidelity.com&gt;
#
# SPDX-License-Identifier: MIT
#
&#34;&#34;&#34;Account loader plugins specific to Azure.

The plug-in in this module allows a user to select subscriptions using the
metadata filters on the `awsrun.cli` instead of explicitly listing accounts to
process.  For accounts that are explicitly specified, the plug-ins are used to
validate those accounts exist. Most plugins in this module attach metadata
attributes to the account objects, which are made available to command authors.

Refer to the plug-in&#39;s documentation for a list of valid options that can be
provided via the configuration file or via azurerun CLI flags. CLI flags
override the values defined in the configuration file. The `plugin` key may be
one of the following values:

awsrun.plugins.accts.azure.AzureCLI
:  `AzureCLI` loads subscriptions and metadata for those subscriptions via the
Azure CLI `az account list --all`  command.
&#34;&#34;&#34;
import json
import logging
import re
import shutil
import subprocess

from awsrun.acctload import MetaAccountLoader
from awsrun.plugmgr import Plugin


LOG = logging.getLogger(__name__)


class AzureCLI(Plugin):
    &#34;&#34;&#34;Account loader plug-in that obtains accounts via the Azure CLI.

    ## Overview

    Accounts specified on the awsrun CLI via the `--account` or `--account-file`
    will be validated against the list of subscriptions obtained from the Azure
    CLI `az account list --all` command.  More importantly, the loaded accounts
    will include metadata associated with each from the JSON output of the Azure
    CLI command.  This metadata can be used to select accounts using the
    `--include` and `--exclude` awsrun CLI flags.

    To use this plug-in, the Azure CLI must be installed. The user must also
    login via the Azure CLI `az login` command. Upon login, the subscriptions
    available to the user will be retrieved and stored locally by the Azure CLI.
    It&#39;s important to understand that the accounts loaded by this plug-in will
    only be as recent as the last login. To refresh the list of accounts visible
    to this plug-in, simply login in again via `az login`.

    The following metadata is attached to each subscription: `id` (str), `name`
    (str), `cloudName` (str), `tenantId` (str), `homeTenantId` (str), `state`
    (str), and `isDefault` (bool). In addition, the name of an Azure
    subscription can be parsed for additional metadata attributes. For example,
    assume the following Azure subscription names:

    - azure-retail-prod
    - azure-retail-nonprod
    - azure-wholesale-prod
    - azure-wholesale-nonprod

    Setting the `name_regexp` configuration option or the `--loader-name-regexp`
    command line flag to the following regexp `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)`
    will attach the `bu` and `env` metadata attributes as well. More precisely,
    each **named** capture group in the pattern becomes an available metadata
    attribute. If a subscription name does not match the pattern, the additional
    attributes will be set to `None`.

    With the accounts loaded and metadata attached, users can specify which
    accounts to process using the `--include` and `--exclude` command line
    options. In the following example, only production retail accounts will be
    selected:

        $ azurerun --include bu=retail --include env=prod az network vnet list

    To query the `isDefault` attribute -- a boolean value, not a string -- one
    must use a type specification:

        $ azurerun --include isDefault=bool:True az network vnet list

    For more information on how to use the CLI and metadata filters, refer to
    the CLI user guide in `awsrun.cli`.

    ## Configuration

    Options with an asterisk are mandatory and must be provided:

        Accounts:
            plugin: awsrun.plugins.accts.azure.AzureCLI
            options:
              name_regexp: STRING

    ## Plug-in Options

    Options can be overridden on the azurerun CLI via command line flags.
    In those cases, the CLI flags are specified next to the option name below:

    `name_regexp`, `--loader-name-regexp`
    : Specifies a regular expression with named capture groups that will be
    applied to each Azure subscription&#39;s name to create additional metadata
    attributes that can be used when filtering or by command authors. For
    example, `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)` will add two metadata
    attributes, `bu` and `env`, on top of the default ones. If a name does not
    match, the attributes specified by the capture groups will be set to None.
    &#34;&#34;&#34;

    def __init__(self, parser, cfg):
        super().__init__(parser, cfg)

        # Define the arguments that we want to allow a user to override via the
        # main CLI. Any CLI args added via add_argument will be commingled with
        # the main awsrun args, so they are prefixed with &#39;--loader-&#39; to lessen
        # chance of collision.
        group = parser.add_argument_group(&#34;account loader options&#34;)
        group.add_argument(
            &#34;--loader-name-regexp&#34;,
            metavar=&#34;STRING&#34;,
            default=cfg(&#34;name_regexp&#34;),
            help=&#34;regexp applied to subscription name for metadata attributes&#34;,
        )

    def instantiate(self, args):
        return AzureCLIAccountLoader(name_regexp=args.loader_name_regexp)


class AzureCLIAccountLoader(MetaAccountLoader):
    &#34;&#34;&#34;Creates an `awsrun.acctload.AccountLoader` with accounts loaded from the Azure CLI.

    The following metadata is attached to each account: `id` (str), `name`
    (str), `cloudName` (str), `tenantId` (str), `homeTenantId` (str), `state`
    (str), and `isDefault` (bool). In addition, the name of an Azure
    subscription can be parsed for additional metadata attributes. For example,
    assume the following Azure subscription names:

    - azure-retail-prod
    - azure-retail-nonprod
    - azure-wholesale-prod
    - azure-wholesale-nonprod

    Setting the `name_regexp` argument to the following regexp
    `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.*)` will attach the `bu` and `env` metadata
    attributes as well. More precisely, each **named** capture group in the
    pattern becomes an available metadata attribute. If a subscription name does
    not match the pattern, the additional attributes will be set to `None`.
    &#34;&#34;&#34;

    def __init__(self, name_regexp=None):
        if not shutil.which(&#34;az&#34;):
            raise RuntimeError(
                &#34;Please install the Azure CLI and ensure &#39;az&#39; is in your path&#34;
            )

        # Check to make sure it&#39;s a valid regexp. Don&#39;t catch exception as
        # azurerun will catch it and report to user.
        if name_regexp:
            try:
                name_regexp = re.compile(name_regexp)
            except re.error as e:
                raise ValueError(f&#34;Subscription name regexp invalid: {e}&#34;) from e
            if not name_regexp.groupindex:
                raise ValueError(&#34;Subscription name regexp has no named capture groups&#34;)

        # Use the Azure CLI to get the list of subscriptions the user has access
        # to. It is up to the user to run az login. If they don&#39;t we&#39;ll print
        # that error.
        result = subprocess.run(
            [&#34;az&#34;, &#34;account&#34;, &#34;list&#34;, &#34;--all&#34;], capture_output=True, check=True
        )

        # The Azure CLI always returns 0, so we must check to see if anything
        # was sent to stderr.
        if result.stderr:
            raise RuntimeError(result.stderr.decode(&#34;utf-8&#34;))

        accts = []
        for subscription in json.loads(result.stdout):

            # Remove non-scalar elements
            subscription.pop(&#34;user&#34;, None)
            subscription.pop(&#34;managedByTenants&#34;, None)

            if not name_regexp:
                accts.append(subscription)
                continue

            match = name_regexp.search(subscription.get(&#34;name&#34;))
            if match:
                for k, v in match.groupdict().items():
                    subscription[k] = v
            else:
                LOG.info(
                    &#34;%s does not match %s&#34;,
                    name_regexp.pattern,
                    subscription.get(&#34;name&#34;),
                )
            accts.append(subscription)

        super().__init__(accts)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="awsrun.plugins.accts.azure.AzureCLI"><code class="flex name class">
<span>class <span class="ident">AzureCLI</span></span>
<span>(</span><span>parser, cfg)</span>
</code></dt>
<dd>
<section class="desc"><p>Account loader plug-in that obtains accounts via the Azure CLI.</p>
<h2 id="overview">Overview</h2>
<p>Accounts specified on the awsrun CLI via the <code>--account</code> or <code>--account-file</code>
will be validated against the list of subscriptions obtained from the Azure
CLI <code>az account list --all</code> command.
More importantly, the loaded accounts
will include metadata associated with each from the JSON output of the Azure
CLI command.
This metadata can be used to select accounts using the
<code>--include</code> and <code>--exclude</code> awsrun CLI flags.</p>
<p>To use this plug-in, the Azure CLI must be installed. The user must also
login via the Azure CLI <code>az login</code> command. Upon login, the subscriptions
available to the user will be retrieved and stored locally by the Azure CLI.
It's important to understand that the accounts loaded by this plug-in will
only be as recent as the last login. To refresh the list of accounts visible
to this plug-in, simply login in again via <code>az login</code>.</p>
<p>The following metadata is attached to each subscription: <code>id</code> (str), <code>name</code>
(str), <code>cloudName</code> (str), <code>tenantId</code> (str), <code>homeTenantId</code> (str), <code>state</code>
(str), and <code>isDefault</code> (bool). In addition, the name of an Azure
subscription can be parsed for additional metadata attributes. For example,
assume the following Azure subscription names:</p>
<ul>
<li>azure-retail-prod</li>
<li>azure-retail-nonprod</li>
<li>azure-wholesale-prod</li>
<li>azure-wholesale-nonprod</li>
</ul>
<p>Setting the <code>name_regexp</code> configuration option or the <code>--loader-name-regexp</code>
command line flag to the following regexp <code>^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)</code>
will attach the <code>bu</code> and <code>env</code> metadata attributes as well. More precisely,
each <strong>named</strong> capture group in the pattern becomes an available metadata
attribute. If a subscription name does not match the pattern, the additional
attributes will be set to <code>None</code>.</p>
<p>With the accounts loaded and metadata attached, users can specify which
accounts to process using the <code>--include</code> and <code>--exclude</code> command line
options. In the following example, only production retail accounts will be
selected:</p>
<pre><code>$ azurerun --include bu=retail --include env=prod az network vnet list
</code></pre>
<p>To query the <code>isDefault</code> attribute &ndash; a boolean value, not a string &ndash; one
must use a type specification:</p>
<pre><code>$ azurerun --include isDefault=bool:True az network vnet list
</code></pre>
<p>For more information on how to use the CLI and metadata filters, refer to
the CLI user guide in <code><a title="awsrun.cli" href="../../cli.html">awsrun.cli</a></code>.</p>
<h2 id="configuration">Configuration</h2>
<p>Options with an asterisk are mandatory and must be provided:</p>
<pre><code>Accounts:
    plugin: awsrun.plugins.accts.azure.AzureCLI
    options:
      name_regexp: STRING
</code></pre>
<h2 id="plug-in-options">Plug-in Options</h2>
<p>Options can be overridden on the azurerun CLI via command line flags.
In those cases, the CLI flags are specified next to the option name below:</p>
<dl>
<dt><code>name_regexp</code>, <code>--loader-name-regexp</code></dt>
<dd>Specifies a regular expression with named capture groups that will be
applied to each Azure subscription's name to create additional metadata
attributes that can be used when filtering or by command authors. For
example, <code>^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)</code> will add two metadata
attributes, <code>bu</code> and <code>env</code>, on top of the default ones. If a name does not
match, the attributes specified by the capture groups will be set to None.</dd>
</dl></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AzureCLI(Plugin):
    &#34;&#34;&#34;Account loader plug-in that obtains accounts via the Azure CLI.

    ## Overview

    Accounts specified on the awsrun CLI via the `--account` or `--account-file`
    will be validated against the list of subscriptions obtained from the Azure
    CLI `az account list --all` command.  More importantly, the loaded accounts
    will include metadata associated with each from the JSON output of the Azure
    CLI command.  This metadata can be used to select accounts using the
    `--include` and `--exclude` awsrun CLI flags.

    To use this plug-in, the Azure CLI must be installed. The user must also
    login via the Azure CLI `az login` command. Upon login, the subscriptions
    available to the user will be retrieved and stored locally by the Azure CLI.
    It&#39;s important to understand that the accounts loaded by this plug-in will
    only be as recent as the last login. To refresh the list of accounts visible
    to this plug-in, simply login in again via `az login`.

    The following metadata is attached to each subscription: `id` (str), `name`
    (str), `cloudName` (str), `tenantId` (str), `homeTenantId` (str), `state`
    (str), and `isDefault` (bool). In addition, the name of an Azure
    subscription can be parsed for additional metadata attributes. For example,
    assume the following Azure subscription names:

    - azure-retail-prod
    - azure-retail-nonprod
    - azure-wholesale-prod
    - azure-wholesale-nonprod

    Setting the `name_regexp` configuration option or the `--loader-name-regexp`
    command line flag to the following regexp `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)`
    will attach the `bu` and `env` metadata attributes as well. More precisely,
    each **named** capture group in the pattern becomes an available metadata
    attribute. If a subscription name does not match the pattern, the additional
    attributes will be set to `None`.

    With the accounts loaded and metadata attached, users can specify which
    accounts to process using the `--include` and `--exclude` command line
    options. In the following example, only production retail accounts will be
    selected:

        $ azurerun --include bu=retail --include env=prod az network vnet list

    To query the `isDefault` attribute -- a boolean value, not a string -- one
    must use a type specification:

        $ azurerun --include isDefault=bool:True az network vnet list

    For more information on how to use the CLI and metadata filters, refer to
    the CLI user guide in `awsrun.cli`.

    ## Configuration

    Options with an asterisk are mandatory and must be provided:

        Accounts:
            plugin: awsrun.plugins.accts.azure.AzureCLI
            options:
              name_regexp: STRING

    ## Plug-in Options

    Options can be overridden on the azurerun CLI via command line flags.
    In those cases, the CLI flags are specified next to the option name below:

    `name_regexp`, `--loader-name-regexp`
    : Specifies a regular expression with named capture groups that will be
    applied to each Azure subscription&#39;s name to create additional metadata
    attributes that can be used when filtering or by command authors. For
    example, `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.+)` will add two metadata
    attributes, `bu` and `env`, on top of the default ones. If a name does not
    match, the attributes specified by the capture groups will be set to None.
    &#34;&#34;&#34;

    def __init__(self, parser, cfg):
        super().__init__(parser, cfg)

        # Define the arguments that we want to allow a user to override via the
        # main CLI. Any CLI args added via add_argument will be commingled with
        # the main awsrun args, so they are prefixed with &#39;--loader-&#39; to lessen
        # chance of collision.
        group = parser.add_argument_group(&#34;account loader options&#34;)
        group.add_argument(
            &#34;--loader-name-regexp&#34;,
            metavar=&#34;STRING&#34;,
            default=cfg(&#34;name_regexp&#34;),
            help=&#34;regexp applied to subscription name for metadata attributes&#34;,
        )

    def instantiate(self, args):
        return AzureCLIAccountLoader(name_regexp=args.loader_name_regexp)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="awsrun.plugmgr.Plugin" href="../../plugmgr.html#awsrun.plugmgr.Plugin">Plugin</a></li>
</ul>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="awsrun.plugmgr.Plugin" href="../../plugmgr.html#awsrun.plugmgr.Plugin">Plugin</a></b></code>:
<ul class="hlist">
<li><code><a title="awsrun.plugmgr.Plugin.instantiate" href="../../plugmgr.html#awsrun.plugmgr.Plugin.instantiate">instantiate</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="awsrun.plugins.accts.azure.AzureCLIAccountLoader"><code class="flex name class">
<span>class <span class="ident">AzureCLIAccountLoader</span></span>
<span>(</span><span>name_regexp=None)</span>
</code></dt>
<dd>
<section class="desc"><p>Creates an <code><a title="awsrun.acctload.AccountLoader" href="../../acctload.html#awsrun.acctload.AccountLoader">AccountLoader</a></code> with accounts loaded from the Azure CLI.</p>
<p>The following metadata is attached to each account: <code>id</code> (str), <code>name</code>
(str), <code>cloudName</code> (str), <code>tenantId</code> (str), <code>homeTenantId</code> (str), <code>state</code>
(str), and <code>isDefault</code> (bool). In addition, the name of an Azure
subscription can be parsed for additional metadata attributes. For example,
assume the following Azure subscription names:</p>
<ul>
<li>azure-retail-prod</li>
<li>azure-retail-nonprod</li>
<li>azure-wholesale-prod</li>
<li>azure-wholesale-nonprod</li>
</ul>
<p>Setting the <code>name_regexp</code> argument to the following regexp
<code>^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.*)</code> will attach the <code>bu</code> and <code>env</code> metadata
attributes as well. More precisely, each <strong>named</strong> capture group in the
pattern becomes an available metadata attribute. If a subscription name does
not match the pattern, the additional attributes will be set to <code>None</code>.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AzureCLIAccountLoader(MetaAccountLoader):
    &#34;&#34;&#34;Creates an `awsrun.acctload.AccountLoader` with accounts loaded from the Azure CLI.

    The following metadata is attached to each account: `id` (str), `name`
    (str), `cloudName` (str), `tenantId` (str), `homeTenantId` (str), `state`
    (str), and `isDefault` (bool). In addition, the name of an Azure
    subscription can be parsed for additional metadata attributes. For example,
    assume the following Azure subscription names:

    - azure-retail-prod
    - azure-retail-nonprod
    - azure-wholesale-prod
    - azure-wholesale-nonprod

    Setting the `name_regexp` argument to the following regexp
    `^azure-(?P&lt;bu&gt;[^-]+)-(?P&lt;env&gt;.*)` will attach the `bu` and `env` metadata
    attributes as well. More precisely, each **named** capture group in the
    pattern becomes an available metadata attribute. If a subscription name does
    not match the pattern, the additional attributes will be set to `None`.
    &#34;&#34;&#34;

    def __init__(self, name_regexp=None):
        if not shutil.which(&#34;az&#34;):
            raise RuntimeError(
                &#34;Please install the Azure CLI and ensure &#39;az&#39; is in your path&#34;
            )

        # Check to make sure it&#39;s a valid regexp. Don&#39;t catch exception as
        # azurerun will catch it and report to user.
        if name_regexp:
            try:
                name_regexp = re.compile(name_regexp)
            except re.error as e:
                raise ValueError(f&#34;Subscription name regexp invalid: {e}&#34;) from e
            if not name_regexp.groupindex:
                raise ValueError(&#34;Subscription name regexp has no named capture groups&#34;)

        # Use the Azure CLI to get the list of subscriptions the user has access
        # to. It is up to the user to run az login. If they don&#39;t we&#39;ll print
        # that error.
        result = subprocess.run(
            [&#34;az&#34;, &#34;account&#34;, &#34;list&#34;, &#34;--all&#34;], capture_output=True, check=True
        )

        # The Azure CLI always returns 0, so we must check to see if anything
        # was sent to stderr.
        if result.stderr:
            raise RuntimeError(result.stderr.decode(&#34;utf-8&#34;))

        accts = []
        for subscription in json.loads(result.stdout):

            # Remove non-scalar elements
            subscription.pop(&#34;user&#34;, None)
            subscription.pop(&#34;managedByTenants&#34;, None)

            if not name_regexp:
                accts.append(subscription)
                continue

            match = name_regexp.search(subscription.get(&#34;name&#34;))
            if match:
                for k, v in match.groupdict().items():
                    subscription[k] = v
            else:
                LOG.info(
                    &#34;%s does not match %s&#34;,
                    name_regexp.pattern,
                    subscription.get(&#34;name&#34;),
                )
            accts.append(subscription)

        super().__init__(accts)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="awsrun.acctload.MetaAccountLoader" href="../../acctload.html#awsrun.acctload.MetaAccountLoader">MetaAccountLoader</a></li>
<li><a title="awsrun.acctload.AccountLoader" href="../../acctload.html#awsrun.acctload.AccountLoader">AccountLoader</a></li>
</ul>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="awsrun.acctload.MetaAccountLoader" href="../../acctload.html#awsrun.acctload.MetaAccountLoader">MetaAccountLoader</a></b></code>:
<ul class="hlist">
<li><code><a title="awsrun.acctload.MetaAccountLoader.accounts" href="../../acctload.html#awsrun.acctload.MetaAccountLoader.accounts">accounts</a></code></li>
<li><code><a title="awsrun.acctload.MetaAccountLoader.acct_id" href="../../acctload.html#awsrun.acctload.MetaAccountLoader.acct_id">acct_id</a></code></li>
<li><code><a title="awsrun.acctload.MetaAccountLoader.attributes" href="../../acctload.html#awsrun.acctload.MetaAccountLoader.attributes">attributes</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="awsrun.plugins.accts" href="index.html">awsrun.plugins.accts</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="awsrun.plugins.accts.azure.AzureCLI" href="#awsrun.plugins.accts.azure.AzureCLI">AzureCLI</a></code></h4>
</li>
<li>
<h4><code><a title="awsrun.plugins.accts.azure.AzureCLIAccountLoader" href="#awsrun.plugins.accts.azure.AzureCLIAccountLoader">AzureCLIAccountLoader</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>